# RTL 模块设计文档

本文档详细说明了 `rtl` 目录中每个 Verilog 模块的功能、接口和内部逻辑。

---

## 模块: `accumulator`
- **文件:** `rtl/accumulator.v`
- **功能描述:**
  实现一个51位的累加器。在每个时钟周期，如果使能，它会将输入的27位值`a`加到自身左移一位后的结果上。该模块是计算核心的最后阶段，用于累积乘加结果。
- **端口说明:**
| 端口 | 方向 | 位宽 | 描述 |
|---|---|---|---|
| `a` | `input` | 27 | 要累加的输入数据。 |
| `clk` | `input` | 1 | 时钟信号。 |
| `acm_en` | `input` | 1 | 累加器使能信号，高电平有效。 |
| `rstn` | `input` | 1 | 异步低电平复位。 |
| `st` | `input` | 1 | 累加器启停/复位信号。当`st`为高时，累加器清零。 |
| `nout` | `output` | 51 | 累加结果输出。 |
- **内部逻辑:**
  - 内部有一个51位的寄存器 `nout_1` 用于存储累加值。
  - 使用一个 `se_cla` 模块（符号扩展先行进位加法器）来执行核心的加法操作：`(nout_1 << 1) + a`。
  - 采用时序逻辑，在时钟上升沿或复位信号下降沿更新寄存器。`acm_en` 控制是否执行累加，`st` 信号可以强制将累加器清零。

---

## 模块: `add`
- **文件:** `rtl/add.v`
- **功能描述:**
  一个参数化的通用加法器，可以根据控制信号`sus`执行有符号或无符号加法。
- **参数说明:**
| 参数 | 默认值 | 描述 |
|---|---|---|
| `width` | 12 | 加法器的位宽。 |
- **端口说明:**
| 端口 | 方向 | 位宽 | 描述 |
|---|---|---|---|
| `a` | `input` | `width` | 加数a。 |
| `b` | `input` | `width` | 加数b。 |
| `sus` | `input` | 1 | 符号控制。`1`表示有符号加法，`0`表示无符号加法。 |
| `sum` | `output` | `width+1` | 加法结果，位宽比输入多一位以容纳进位。 |
- **内部逻辑:**
  - 当 `sus` 为 `1` 时，对输入 `a` 和 `b` 进行符号位扩展（复制最高位），然后相加。
  - 当 `sus` 为 `0` 时，对输入 `a` 和 `b` 进行零扩展，然后相加。

---

## 模块: `cim_array`
- **文件:** `rtl/cim_array.v`
- **功能描述:**
  CIM（存内计算）阵列，由两个 `cim_bank` 实例构成。它负责将写数据和地址路由到正确的存储体。
- **端口说明:**
| 端口 | 方向 | 位宽 | 描述 |
|---|---|---|---|
| `D` | `input` | 24 | 写入存储体的数据。 |
| `WA0` | `input` | 8 | 存储体0的写地址（one-hot）。 |
| `WA1` | `input` | 8 | 存储体1的写地址（one-hot）。 |
| `wb0_a`, `wb0_b` | `output` | 96 | 存储体0的权重输出（a为低12位，b为高12位）。 |
| `wb1_a`, `wb1_b` | `output` | 96 | 存储体1的权重输出（a为低12位，b为高12位）。 |
- **内部逻辑:**
  - 实例化了两个 `cim_bank` 模块：`bank0_inst` 和 `bank1_inst`。
  - 将对应的地址和数据信号连接到每个 `cim_bank` 实例。

---

## 模块: `cim_array_ctrl`
- **文件:** `rtl/cim_array_ctrl.v`
- **功能描述:**
  CIM阵列的写操作控制器。它根据片选信号 `cima` 将输入的写地址 `WA` 路由到两个存储体地址 `WA0` 或 `WA1` 中的一个，实现对特定存储体的选择性写入。
- **端口说明:**
| 端口 | 方向 | 位宽 | 描述 |
|---|---|---|---|
| `D` | `input` | 24 | 输入的写数据。 |
| `WA` | `input` | 8 | 输入的写地址。 |
| `cima` | `input` | 1 | 片选信号。`0`选择bank0，`1`选择bank1。 |
| `D1` | `output` | 24 | 透传的写数据。 |
| `WA0` | `output` | 8 | bank0的写地址。 |
| `WA1` | `output` | 8 | bank1的写地址。 |
- **内部逻辑:**
  - 数据 `D` 被直接透传到 `D1`。
  - 使用一个组合逻辑块，根据 `cima` 的值，将 `WA` 赋给 `WA0` 或 `WA1`，同时将另一个置零，以确保只有一个存储体被写入。

---

## 模块: `cim_bank`
- **文件:** `rtl/cim_bank.v`
- **功能描述:**
  一个独立的CIM存储体，内部是一个 8x24-bit 的存储器阵列。它根据one-hot编码的地址写入数据，并持续地将所有存储单元的内容取反后输出，用于实现后续的存内计算逻辑。
- **端口说明:**
| 端口 | 方向 | 位宽 | 描述 |
|---|---|---|---|
| `D` | `input` | 24 | 写入数据。 |
| `WA` | `input` | 8 | one-hot编码的写地址。 |
| `wb_a` | `output` | 96 | 8个存储单元的低12位拼接并取反后的结果。 |
| `wb_b` | `output` | 96 | 8个存储单元的高12位拼接并取反后的结果。 |
- **内部逻辑:**
  - 写操作：使用 `case` 语句根据 one-hot 的 `WA` 地址将数据 `D` 写入对应的 `mem` 单元。
  - 读操作：这是一个组合逻辑输出。`wb_a` 是将8个存储单元的低12位（`mem[i][11:0]`）拼接后整体取反的结果。`wb_b` 是对高12位（`mem[i][23:12]`）做同样操作的结果。输出取反是为了配合后续的OAI门实现与逻辑。

---

## 模块: `gctrl`
- **文件:** `rtl/gctrl.v`
- **功能描述:**
  全局时序控制器。它是一个状态机，在接收到 `start` 信号后，生成一个从0开始递增的 `sel` 信号和一个用于控制累加器的 `st` 信号，以驱动整个计算流程。
- **端口说明:**
| 端口 | 方向 | 位宽 | 描述 |
|---|---|---|---|
| `clk` | `input` | 1 | 时钟信号。 |
| `rstn` | `input` | 1 | 异步低电平复位。 |
| `start` | `input` | 1 | 开始计算的触发信号。 |
| `inwidth` | `input` | 1 | 输入位宽选择。`1`为24位，`0`为12位。 |
| `sel` | `output` | 6 | 迭代选择信号，用于从输入向量中选择不同的位。 |
| `st` | `output` | 1 | 累加器控制信号。`0`表示累加，`1`表示停止/复位。 |
- **内部逻辑:**
  - 包含一个三状态的状态机（IDLE, COUNT, DONE）。
  - IDLE状态等待 `start` 信号。
  - COUNT状态下，`sel` 计数器从0递增到 `max_count`（由`inwidth`决定），同时 `st` 拉低以启动累加器。
  - 到达 `max_count` 后进入DONE状态，然后返回IDLE。

---

## 模块: `global_io`
- **文件:** `rtl/global_io.v`
- **功能描述:**
  全局IO模块，负责连接MAC单元和最终的累加器。它将来自低12位和高12位权重计算的两个MAC结果相加，然后将合并后的结果送入累加器。
- **端口说明:**
| 端口 | 方向 | 位宽 | 描述 |
|---|---|---|---|
| `macout_a` | `input` | 15 | 来自低12位权重的MAC结果。 |
| `macout_b` | `input` | 15 | 来自高12位权重的MAC结果。 |
| `clk` | `input` | 1 | 时钟信号。 |
| `acm_en` | `input` | 1 | 累加器使能。 |
| `rstn` | `input` | 1 | 复位信号。 |
| `st` | `input` | 1 | 累加器状态信号。 |
| `wwidth` | `input` | 1 | 权重位宽选择。`1`为24位，`0`为12位。 |
| `nout` | `output` | 51 | 最终的累加输出。 |
- **内部逻辑:**
  - 使用一个27位的 `add` 模块将 `macout_a` 和移位后的 `macout_b` 相加。`macout_b` 的移位由 `wwidth` 控制，以匹配其作为高位的权重。
  - 将加法结果送入一个 `accumulator` 实例进行最终的累加。

---

## 模块: `local_mac`
- **文件:** `rtl/local_mac.v`
- **功能描述:**
  本地MAC（乘加）单元。它执行8路并行的乘法操作，并使用一个三级加法器树将8个乘法结果汇总，得到最终的15位MAC输出。
- **端口说明:**
| 端口 | 方向 | 位宽 | 描述 |
|---|---|---|---|
| `wb0`, `wb1` | `input` | 96 | 权重输入。 |
| `rwlb_row0`, `rwlb_row1` | `input` | 8 | 行驱动信号，代表了输入数据。 |
| `sus` | `input` | 1 | 有符号/无符号加法控制。 |
| `mac_out` | `output` | 15 | 15位的MAC计算结果。 |
- **内部逻辑:**
  - 实例化8个 `oai_mult` 模块，每个模块处理12位权重和1位输入数据。
  - 使用一个三级加法器树（由7个 `add` 模块构成）将8个12位的乘法结果相加，最终输出一个15位的结果。

---

## 模块: `oai_mult`
- **文件:** `rtl/oai_mult.v`
- **功能描述:**
  实现一个12位的OAI（Or-And-Invert）逻辑门，这是CIM架构中实现等效乘法的基础。它执行 `~((a | c) & (b | d))` 的逻辑运算。
- **端口说明:**
| 端口 | 方向 | 位宽 | 描述 |
|---|---|---|---|
| `a`, `b` | `input` | 12 | 12位权重输入。 |
| `c`, `d` | `input` | 1 | 1位数据输入。 |
| `e` | `output` | 12 | 12位计算结果。 |
- **内部逻辑:**
  - 将1位的 `c` 和 `d` 扩展到12位。
  - 执行 `~((a | c_ext) & (b | d_ext))` 的位运算。当存储器输出的权重 `a` 和 `b` 是反相的，并且行驱动信号 `c` 和 `d` 也是反相的时，这个OAI逻辑等效于一个与门，从而实现乘法。

---

## 模块: `rwldrv`
- **文件:** `rtl/rwldrv.v`
- **功能描述:**
  行/字线驱动器。它根据 `sel` 信号从192位的输入数据向量 `xin0` 中提取出一个特定的8位切片，然后根据 `cima` 信号将取反后的结果驱动到对应的存储体行上。
- **端口说明:**
| 端口 | 方向 | 位宽 | 描述 |
|---|---|---|---|
| `xin0` | `input` | 192 | 输入数据向量，包含8个24位数据。 |
| `sel` | `input` | 6 | 位选择信号。 |
| `cima` | `input` | 1 | 片选信号，选择bank0或bank1。 |
| `inwidth` | `input` | 1 | 输入数据位宽选择。 |
| `rwlb_row0` | `output` | 8 | bank0的行驱动信号。 |
| `rwlb_row1` | `output` | 8 | bank1的行驱动信号。 |
- **内部逻辑:**
  - 根据 `sel` 和 `inwidth` 计算出要从每个24位数据中提取的位的索引。
  - 从8个24位数据中分别提取出该位，组成一个8位的向量 `selected_bits`。
  - 根据 `cima` 的值，将 `~selected_bits` 赋给 `rwlb_row0` 或 `rwlb_row1`，同时将另一个驱动信号强制设为全1（`8'hFF`）以屏蔽该bank。

---

## 模块: `s_cla`
- **文件:** `rtl/s_cla.v`
- **功能描述:**
  一个高性能、完全展开的24位分块先行进位加法器（Carry-Lookahead Adder）。它采用两级CLA结构（每4位一个块），以实现高速的纯组合逻辑加法。
- **端口说明:**
| 端口 | 方向 | 位宽 | 描述 |
|---|---|---|---|
| `a`, `b` | `input` | 24 | 24位加数。 |
| `cin` | `input` | 1 | 外部进位输入。 |
| `sum` | `output` | 24 | 24位和。 |
- **内部逻辑:**
  - **第1步:** 计算每一位的生成（g）和传播（p）信号。
  - **第2步:** 计算每个4位块的块生成（bg）和块传播（bp）信号。
  - **第3步:** 计算块间的进位 `c_block`。
  - **第4步:** 计算每一位的最终进位 `c`。
  - **第5步:** 计算最终的和 `sum = p ^ c`。

---

## 模块: `se_cla`
- **文件:** `rtl/se_cla.v`
- **功能描述:**
  一个特殊的51位加法器，用于将一个27位数 `a` 和一个51位数 `b` 相加。它对 `a` 进行符号位扩展，并使用高性能的 `s_cla` 来加速高位的计算。
- **端口说明:**
| 端口 | 方向 | 位宽 | 描述 |
|---|---|---|---|
| `a` | `input` | 27 | 27位输入。 |
| `b` | `input` | 51 | 51位输入。 |
| `sum` | `output` | 51 | 51位和。 |
- **内部逻辑:**
  - 将27位的 `a` 符号位扩展到51位。
  - 将加法拆分为两部分：
    - 低27位使用一个常规的 `add` 模块计算。
    - 高24位使用一个 `s_cla` 模块计算，并将低位加法的进位作为其 `cin`。
  - 最后将高位和低位的计算结果拼接起来。

---

## 模块: `top`
- **文件:** `rtl/top.v`
- **功能描述:**
  设计的顶层模块，集成了所有子模块，构成完整的CIM宏单元。它负责处理数据写入、时序控制、存内计算和最终结果的累加。
- **端口说明:**
  包含所有对外接口，如数据输入`D`、`xin0`，控制信号`clk`, `rstn`, `start`等，以及最终输出`nout`。
- **内部逻辑:**
  - **实例化所有核心模块:** `cim_array_ctrl`, `cim_array`, `gctrl`, `rwldrv`, `local_mac` (x2), `global_io`。
  - **Ping-Pong MUX:** 使用 `cima` 信号作为选择器，从两个存储体（bank0, bank1）的输出中选择当前活动的权重（`active_wb_a`, `active_wb_b`）送入计算核心。
  - **双MAC计算:** 实例化两个 `local_mac` 单元，一个用于处理低12位权重（`mac_out_low`），另一个处理高12位权重（`mac_out_high`）。
  - **连接:** 将所有模块按照设计架构连接起来，形成完整的数据流和控制流。
